\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{pl-syntax}
  [2019/04/22 version 1.0.0 Abstract Syntax Definitions for Programming Languages]

\RequirePackage{etoolbox}

% Suppresses row breaks when set to true. Used to prevent unnecessary
% line breaks that would otherwise be generated by default.
\newtoggle{@pl@syntax@suppressNewRow}

% True when the next alternative to be specified is the first one in a category.
% Used to suppress a leading separator.
\newtoggle{@pl@syntax@firstAlternative}

% The symbol used between alternatives.
\newcommand{\@pl@syntax@altSymbol}{\,\mid\,}

% Generate an alternative symbol unless this is the first alternative.
\newcommand{\@pl@syntax@alt}{%
  \iftoggle{@pl@syntax@firstAlternative}%
    {\global\togglefalse{@pl@syntax@firstAlternative}}%
    {\@pl@syntax@altSymbol}%
}

% Start a new row.
\newcommand{\@pl@syntax@newRow}{%
  \iftoggle{@pl@syntax@suppressNewRow}%
    {\global\togglefalse{@pl@syntax@suppressNewRow}}%
    {\\}%
}

% Define the abstract syntax of a programming language.
\newenvironment{syntax}{%
  % Define a new syntactic category (e.g. expressions, statements).
  \newcommand{\category}[2][]{%
    \@pl@syntax@newRow \textrm{##1} & ##2 & ::= &%
    \global\toggletrue{@pl@syntax@firstAlternative}%
  }%
  % A category with no right-hand side. This allows you to name meta
  % variables without defining the syntactic category explicitly.
  \newcommand{\abstractCategory}[2][]{%
    \@pl@syntax@newRow \textrm{##1} & ##2%
  }%
  % A category where the right-hand side is an abstract set.
  \newcommand{\categoryFromSet}[3][]{%
    \@pl@syntax@newRow \textrm{##1} & ##2 & \in & ##3%
  }%
  % Define a new alternative for the most recent category.
  \newcommand{\alternative}[1]{%
    \@pl@syntax@alt ##1%
  }%
  % Like `alternative`, but places the clause on a new line.
  \newcommand{\alternativeLine}[1]{%
    \iftoggle{@pl@syntax@firstAlternative}%
      {\alternative{##1}}%
      {\@pl@syntax@newRow & & \@pl@syntax@alt & ##1}%
  }%
  % Add extra information to the most recently declared alternative.
  % For example, you can use this to note that the context is unordered.
  \newcommand{\note}[1]{\@pl@syntax@newRow & & & (\textrm{##1})}%
  % Add vertical space between declarations.
  \newcommand{\separate}[1][1ex]{%
    \\[##1]\global\toggletrue{@pl@syntax@suppressNewRow}%
  }%
  % For grouping alternatives on a new line and aligning right.
  \newcommand{\groupleft}[1]{%
    \\%
    \multicolumn{4}{l}{%
      \togglefalse{@pl@syntax@firstAlternative}%
      \qquad%
      ##1%
    }%
  }
%
  \global\toggletrue{@pl@syntax@suppressNewRow}%
  \[\begin{array}{llcl}%
}
{\end{array}\]\ignorespacesafterend}
